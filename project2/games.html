<!DOCTYPE html>
<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>Games Page</title>
  <link rel="stylesheet" href="./styles/style.css" type="text/css"/>
  <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.6.0/stitch.js"></script>
  <div>
    
    <label id="user_tag"></label>

  </div>
 
 
  <div class="container" id="galleryDiv">


  </div>
</head>

<body>
  <script>
    const client = stitch.Stitch.initializeDefaultAppClient('gamedistributorapp1-rlxbb');
    const db = client.getServiceClient(stitch.RemoteMongoClient.factory, 'mongodb-atlas').db('hw2DB');
    const name = (new URL(window.location.href)).searchParams.get("username");
    const criteria = { username: name }
    document.getElementById("user_tag").textContent="User :"+name;




    db.collection('games').find().toArray().then(function (games){
      if(games != null){
        var array_len=games.length;
        for(var i = 0; i < array_len; i++) {
          var currentGame=games[i].gamename;
          db.collection('rates').find().toArray().then(function(rates,err){
            if(rates != null){
              var sumRates=[];
              
              for (let index = 0; index < rates.length; index++) {
                if(rates[index].gamename==currentGame){
                  sumRates.push(rates[index]);
                }
                
              }


              db.collection('plays').find({gamename:currentGame}).toArray().then(function(plays,err){
            if(plays != null){
              var sumPlays=[];
              
              for (let index = 0; index < plays.length; index++) {
                if(plays[index].gamename==currentGame){
                  sumPlays.push(plays[index]);
                }
                
              }

              console.log(sumRates);
              
             // var userRatings=[];
              for (let index = 0; index < sumPlays.length; index++) {
                const element = sumPlays[index];
                console.log(element);
                //userRatings.push(elementPlays,elementRates);

              }

              for (let index = 0; index < sumRates.length; index++) {
                const element = sumRates[index];
                console.log(element);
              }


            }
          });


            }
          });

          //alert(playsTaken);
          var divMain = document.createElement("div");
          divMain.setAttribute("class","city");
          var divName = document.createElement("div");
          divName.setAttribute("class","desc")
          var divGenres = document.createElement("div");
          divGenres.setAttribute("class","desc")
          var divPlayTime = document.createElement("div");
          divPlayTime.setAttribute("class","desc")
          var divRating = document.createElement("div");
          divRating.setAttribute("class","desc");
          


          var text_gamename=document.createTextNode("Name :  "+games[i].gamename);
          var text_gamegenres=document.createTextNode("Genre(s) :  "+games[i].gamegenres);
          var text_playtime=document.createTextNode("Play Time  :  "+games[i].playtime+" hrs");
          //var text_rating=document.createTextNode("Rating  :  "+ratingSum);

          var img = document.createElement("img");
          img.setAttribute("src", games[i].gamephoto);
          img.setAttribute("height", "250");
          img.setAttribute("width", "250");
        
          divName.appendChild(text_gamename);
          divGenres.appendChild(text_gamegenres);
          divPlayTime.appendChild(text_playtime);
          //divRating.appendChild(text_rating);
          
          divMain.appendChild(img);
          divMain.appendChild(divName);
          divMain.appendChild(divGenres);
          divMain.appendChild(divPlayTime);
          divMain.appendChild(divRating);
        //  divMain.appendChild(divComments);

          document.getElementById("galleryDiv").appendChild(divMain);
        }
        

      }
    });
  </script>

<script>
  function toUserpage(){
      loadUrl("./user.html?username=" + name);
    }
    function loadUrl(newLocation){
      window.location = newLocation;
      return false;
    }
</script>
</body>
<div>
  <button type="button" onclick="toUserpage()">Back to User Page</button>
</div>

</html>
